<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Verfügbarkeits-Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Ticket-Verfügbarkeits-Checker</h1>
            <p class="text-gray-600">Zeigt die freien Ticketkontingente für "Das Weltall neu erleben" an.</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <button id="prevWeekBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">&lt; Vorherige Woche</button>
                    <input type="date" id="datePicker" class="form-input w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <button id="nextWeekBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Nächste Woche &gt;</button>
                </div>
                <button id="fetchBtn" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
                    Anzeigen
                </button>
            </div>
        </div>

        <div id="loading" class="flex justify-center items-center my-8 hidden">
            <div class="loader"></div>
            <p class="ml-4 text-gray-600">Daten werden geladen...</p>
        </div>

        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-4" role="alert">
            <strong class="font-bold">Fehler!</strong>
            <span class="block sm:inline" id="errorMessage"></span>
        </div>

        <div id="resultsContainer" class="bg-white rounded-xl shadow-lg overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead id="tableHeader" class="text-xs text-gray-700 uppercase bg-gray-50">
                    <!-- Header will be dynamically generated here -->
                </thead>
                <tbody id="tableBody">
                    <!-- Content will be dynamically generated here -->
                </tbody>
            </table>
        </div>
         <footer class="text-center text-gray-500 text-xs mt-6">
            <p>Dies ist eine inoffizielle Anwendung. Alle Daten stammen von ticket-regional.de.</p>
             <p><strong>Hinweis:</strong> Um die CORS-Beschränkungen zu umgehen, werden öffentliche Proxy-Dienste verwendet. Diese sind in der Regel zuverlässig, können aber gelegentlich ausfallen.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const datePicker = document.getElementById('datePicker');
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const fetchBtn = document.getElementById('fetchBtn');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const errorMessageSpan = document.getElementById('errorMessage');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const resultsContainer = document.getElementById('resultsContainer');

            // Cache to store fetched HTML data for weeks
            const ticketCache = {};
            const WEEK_IN_SECONDS = 7 * 24 * 60 * 60;

            const getMondayTimestamp = (d) => {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
                const monday = new Date(d.setDate(diff));
                monday.setHours(0, 0, 0, 0); // Normalize to the start of the day
                return Math.floor(monday.getTime() / 1000);
            };
            
            // Set initial date to today
            const today = new Date();
            datePicker.value = today.toISOString().split('T')[0];

            const fetchWeekData = async (startTime) => {
                // If data is already in cache, return it.
                if (ticketCache[startTime]) {
                    return ticketCache[startTime];
                }

                const timeID = '1006912';
                const targetUrl = `https://www.ticket-regional.de/stage_2688.php?timeID=${timeID}&startTime=${startTime}`;
                
                // --- NEW: Array of proxies for fallback mechanism ---
                const proxyUrls = [
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?'
                ];

                for (const proxyUrl of proxyUrls) {
                    try {
                        const fullUrl = proxyUrl + encodeURIComponent(targetUrl);
                        const response = await fetch(fullUrl, { cache: 'no-store' }); // Use no-store to avoid browser caching proxy errors
                        if (!response.ok) {
                            throw new Error(`Proxy/Server-Antwort war nicht in Ordnung. Status: ${response.status}`);
                        }
                        const htmlString = await response.text();
                        
                        // Check if the response is valid HTML from the target site, not an error page from the proxy.
                        if (!htmlString.includes('scheduleContainer')) {
                             throw new Error('Die vom Proxy abgerufenen Daten scheinen ungültig zu sein.');
                        }

                        ticketCache[startTime] = htmlString; // Cache the successful result
                        return htmlString; // Return on first success
                    } catch (err) {
                        console.warn(`Proxy ${proxyUrl} fehlgeschlagen:`, err);
                        // Error will be caught, and the loop will continue to the next proxy.
                    }
                }

                // If the loop completes without a successful fetch, throw a final error.
                throw new Error('Alle Proxies konnten die Daten nicht abrufen. Bitte versuchen Sie es später erneut.');
            };


            const prefetchAdjacentWeeks = (startTime) => {
                // Silently prefetch next and previous weeks without waiting for them
                fetchWeekData(startTime - WEEK_IN_SECONDS).catch(e => {}); // Ignore errors on prefetch
                fetchWeekData(startTime + WEEK_IN_SECONDS).catch(e => {});
            };

            const displayDataForWeek = async (startTime) => {
                loadingDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                tableBody.innerHTML = '';
                tableHeader.innerHTML = '';

                try {
                    const htmlString = await fetchWeekData(startTime);
                    parseAndDisplayData(htmlString);
                    // Once the main data is displayed, prefetch adjacent weeks
                    prefetchAdjacentWeeks(startTime);

                } catch (err) {
                    errorMessageSpan.textContent = `Fehler beim Abrufen der Daten: ${err.message}`;
                    errorDiv.classList.remove('hidden');
                } finally {
                    loadingDiv.classList.add('hidden');
                }
            };

            const parseAndDisplayData = (htmlString) => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');

                const scheduleContainer = doc.querySelector('.scheduleContainer');
                if (!scheduleContainer) {
                    errorMessageSpan.textContent = 'Konnte den Kalender auf der Zielseite nicht finden. Die Seitenstruktur hat sich möglicherweise geändert.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';

                // --- Parse Header ---
                const headerCells = scheduleContainer.querySelectorAll('tr:nth-child(2) .scheduleDayOnly');
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th scope="col" class="px-6 py-3">Uhrzeit</th>';
                headerCells.forEach(cell => {
                    const cleanedHtml = cell.innerHTML.replace(/<br\s*\/?>/gi, ' ');
                    headerRow.innerHTML += `<th scope="col" class="px-6 py-3">${cleanedHtml}</th>`;
                });
                tableHeader.appendChild(headerRow);

                // --- Parse Body Rows ---
                const dataRows = scheduleContainer.querySelectorAll('tr:nth-child(n+3)');
                dataRows.forEach(row => {
                    const timeCell = row.querySelector('.scheduleDayTime');
                    if (!timeCell) return;

                    const time = timeCell.textContent.trim();
                    const newRow = document.createElement('tr');
                    newRow.className = 'bg-white border-b hover:bg-gray-50';
                    newRow.innerHTML = `<th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${time}</th>`;

                    const contentCells = row.querySelectorAll('.scheduleContent.scheduleDay');
                    contentCells.forEach(cell => {
                        let content = '';
                        let cellClass = 'px-6 py-4 text-center';

                        const freeTicketsSpan = cell.querySelector('.scheduleDayFreeTickets');
                        
                        if (freeTicketsSpan) {
                            const count = freeTicketsSpan.textContent.replace(/\D/g, '');
                            content = `Tickets (${count})`;
                            cellClass += ' bg-teal-100 text-teal-800 font-semibold';
                        } else if (cell.textContent.includes('Tickets')) {
                            content = 'Tickets';
                            cellClass += ' bg-blue-100 text-blue-800 font-medium';
                        } else if (cell.textContent.includes('Ausverkauft')) {
                            content = 'Ausverkauft';
                            cellClass += ' bg-red-100 text-red-800';
                        } else if (cell.classList.contains('etStartTimeNotBookable')) {
                            content = '-';
                            cellClass += ' text-gray-400';
                        }

                        newRow.innerHTML += `<td class="${cellClass}">${content}</td>`;
                    });
                    tableBody.appendChild(newRow);
                });

                resultsContainer.classList.remove('hidden');
            };

            const updateDateAndFetch = (days) => {
                const currentDate = new Date(datePicker.value);
                currentDate.setDate(currentDate.getDate() + days);
                datePicker.value = currentDate.toISOString().split('T')[0];
                const startTime = getMondayTimestamp(currentDate);
                displayDataForWeek(startTime);
            };

            prevWeekBtn.addEventListener('click', () => updateDateAndFetch(-7));
            nextWeekBtn.addEventListener('click', () => updateDateAndFetch(7));
            
            const fetchFromDatePicker = () => {
                const selectedDate = new Date(datePicker.value);
                const startTime = getMondayTimestamp(selectedDate);
                displayDataForWeek(startTime);
            };
            
            fetchBtn.addEventListener('click', fetchFromDatePicker);
            datePicker.addEventListener('change', fetchFromDatePicker);

            // Initial fetch on page load
            fetchFromDatePicker();
        });
    </script>

</body>
</html>

